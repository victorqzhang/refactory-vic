<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Post Office API &mdash; Mercury 0.1 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Rest Automation" href="rest-automation.html" />
    <link rel="prev" title="Platform API" href="platform-api.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> Mercury
          </a>
              <div class="version">
                0.1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="start.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="architecture.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="library.html">Libraries and Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="compatability.html">Compatability</a></li>
<li class="toctree-l1"><a class="reference internal" href="terminology.html">Terminology</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="How-tos.html">Pragmatic Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="app-properties.html">Application Properties</a></li>
<li class="toctree-l1"><a class="reference internal" href="route-names.html">Reserved Route Names</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Features</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="platform-api.html">Platform API</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Post Office API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#obtain-an-instance-of-the-post-office-object">Obtain an instance of the post office object</a></li>
<li class="toctree-l2"><a class="reference internal" href="#communication-patterns">Communication patterns</a></li>
<li class="toctree-l2"><a class="reference internal" href="#rpc-request-response">RPC (Request-response)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#asynchronous-drop-n-forget">Asynchronous / Drop-n-forget</a></li>
<li class="toctree-l2"><a class="reference internal" href="#deferred-delivery">Deferred delivery</a></li>
<li class="toctree-l2"><a class="reference internal" href="#call-back">Call-back</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pipeline">Pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="#streaming">Streaming</a></li>
<li class="toctree-l2"><a class="reference internal" href="#broadcast">Broadcast</a></li>
<li class="toctree-l2"><a class="reference internal" href="#join-n-fork">Join-n-fork</a></li>
<li class="toctree-l2"><a class="reference internal" href="#inspecting-event-s-metadata">Inspecting event’s metadata</a></li>
<li class="toctree-l2"><a class="reference internal" href="#default-pojo-mapping">Default PoJo mapping</a></li>
<li class="toctree-l2"><a class="reference internal" href="#retrieve-raw-data-as-a-map">Retrieve raw data as a Map</a></li>
<li class="toctree-l2"><a class="reference internal" href="#custom-pojo-mapping">Custom PoJo mapping</a></li>
<li class="toctree-l2"><a class="reference internal" href="#check-if-a-target-service-is-available">Check if a target service is available</a></li>
<li class="toctree-l2"><a class="reference internal" href="#get-a-list-of-application-instances-that-provide-a-certain-service">Get a list of application instances that provide a certain service</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pub-sub-for-store-n-forward-event-streaming">Pub/Sub for store-n-forward event streaming</a></li>
<li class="toctree-l2"><a class="reference internal" href="#thread-safety">Thread safety</a></li>
<li class="toctree-l2"><a class="reference internal" href="#exception-handling">Exception handling</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="rest-automation.html">Rest Automation</a></li>
<li class="toctree-l1"><a class="reference internal" href="jax-rs.html">JAX-RS and WebServlets</a></li>
<li class="toctree-l1"><a class="reference internal" href="connectors.html">Cloud Connectors</a></li>
<li class="toctree-l1"><a class="reference internal" href="multicast.html">Multicast</a></li>
<li class="toctree-l1"><a class="reference internal" href="additonal-features.html">Additonal Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="version-control.html">Version Control</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Mercury</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Post Office API</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/post-office-api.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="post-office-api">
<h1>Post Office API<a class="headerlink" href="#post-office-api" title="Permalink to this headline"></a></h1>
<p>Post Office is a platform abstraction layer that routes events among functions. It maintains a distributed routing table to ensure that service discovery is instantaneous,</p>
<section id="obtain-an-instance-of-the-post-office-object">
<h2>Obtain an instance of the post office object<a class="headerlink" href="#obtain-an-instance-of-the-post-office-object" title="Permalink to this headline"></a></h2>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">PostOffice</span> <span class="n">po</span> <span class="o">=</span> <span class="n">PostOffice</span><span class="p">.</span><span class="na">getInstance</span><span class="p">();</span>
</pre></div>
</div>
</section>
<section id="communication-patterns">
<h2>Communication patterns<a class="headerlink" href="#communication-patterns" title="Permalink to this headline"></a></h2>
<ul class="simple">
<li><p>RPC <code class="docutils literal notranslate"><span class="pre">“Request-response”,</span> <span class="pre">best</span> <span class="pre">for</span> <span class="pre">interactivity</span></code></p></li>
<li><p>Asynchronous <code class="docutils literal notranslate"><span class="pre">e.g.</span> <span class="pre">Drop-n-forget</span> <span class="pre">and</span> <span class="pre">long</span> <span class="pre">queries</span></code></p></li>
<li><p>Call-back <code class="docutils literal notranslate"><span class="pre">e.g.</span> <span class="pre">Progressive</span> <span class="pre">rendering</span></code></p></li>
<li><p>Pipeline <code class="docutils literal notranslate"><span class="pre">e.g.</span> <span class="pre">Work-flow</span> <span class="pre">application</span></code></p></li>
<li><p>Streaming <code class="docutils literal notranslate"><span class="pre">e.g.</span> <span class="pre">Data</span> <span class="pre">ingest</span></code></p></li>
<li><p>Broadcast <code class="docutils literal notranslate"><span class="pre">e.g.</span> <span class="pre">Concurrent</span> <span class="pre">processing</span> <span class="pre">of</span> <span class="pre">the</span> <span class="pre">same</span> <span class="pre">dataset</span> <span class="pre">with</span> <span class="pre">different</span> <span class="pre">outcomes</span></code></p></li>
</ul>
</section>
<section id="rpc-request-response">
<h2>RPC (Request-response)<a class="headerlink" href="#rpc-request-response" title="Permalink to this headline"></a></h2>
<p>The Mercury framework is 100% event-driven and all communications are asynchronous. To emulate a synchronous RPC, it uses temporary Inbox as a callback function. The target service will send reply to the callback function which in turns delivers the response.</p>
<p>To make an RPC call, you can use the <code class="docutils literal notranslate"><span class="pre">request</span></code> methods. These methods would throw exception if the response status is not 200.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">EventEnvelope</span> <span class="nf">request</span><span class="p">(</span><span class="n">String</span> <span class="n">to</span><span class="p">,</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">Object</span> <span class="n">body</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="p">,</span> <span class="n">TimeoutException</span><span class="p">,</span> <span class="n">AppException</span><span class="p">;</span>
<span class="n">EventEnvelope</span> <span class="nf">request</span><span class="p">(</span><span class="n">String</span> <span class="n">to</span><span class="p">,</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">Object</span> <span class="n">body</span><span class="p">,</span> <span class="n">Kv</span><span class="p">...</span> <span class="n">parameters</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="p">,</span> <span class="n">TimeoutException</span><span class="p">,</span> <span class="n">AppException</span><span class="p">;</span>
<span class="n">EventEnvelope</span> <span class="nf">request</span><span class="p">(</span><span class="n">EventEnvelope</span> <span class="n">event</span><span class="p">,</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="p">,</span> <span class="n">TimeoutException</span><span class="p">,</span> <span class="n">AppException</span><span class="p">;</span>

<span class="c1">// example</span>
<span class="n">EventEnvelope</span> <span class="n">response</span> <span class="o">=</span> <span class="n">po</span><span class="p">.</span><span class="na">request</span><span class="p">(</span><span class="s">&quot;hello.world&quot;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">somePayload</span><span class="p">);</span>
<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;I got response...&quot;</span><span class="o">+</span><span class="n">response</span><span class="p">.</span><span class="na">getBody</span><span class="p">());</span>
</pre></div>
</div>
<p>A non-blocking version of RPC is available with the <code class="docutils literal notranslate"><span class="pre">asyncRequest</span></code> method. Only timeout exception will be sent to the onFailure method. All other cases will be delivered to the onSuccess method. You should check event.getStatus() to handle exception.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">Future</span><span class="o">&lt;</span><span class="n">EventEnvelope</span><span class="o">&gt;</span> <span class="nf">asyncRequest</span><span class="p">(</span><span class="kd">final</span> <span class="n">EventEnvelope</span> <span class="n">event</span><span class="p">,</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="p">;</span>

<span class="c1">// example</span>
<span class="n">Future</span><span class="o">&lt;</span><span class="n">EventEnvelope</span><span class="o">&gt;</span> <span class="n">future</span> <span class="o">=</span> <span class="n">po</span><span class="p">.</span><span class="na">asyncRequest</span><span class="p">(</span><span class="k">new</span> <span class="n">EventEnvelope</span><span class="p">().</span><span class="na">setTo</span><span class="p">(</span><span class="n">SERVICE</span><span class="p">).</span><span class="na">setBody</span><span class="p">(</span><span class="n">TEXT</span><span class="p">),</span> <span class="mi">2000</span><span class="p">);</span>
<span class="n">future</span><span class="p">.</span><span class="na">onSuccess</span><span class="p">(</span><span class="n">event</span> <span class="o">-&gt;</span> <span class="p">{</span>
    <span class="c1">// handle the response event</span>
<span class="p">}).</span><span class="na">onFailure</span><span class="p">(</span><span class="n">ex</span> <span class="o">-&gt;</span> <span class="p">{</span>
    <span class="c1">// handle exception</span>
<span class="p">});</span>
</pre></div>
</div>
<p>Note that Mercury supports Java primitive, Map and PoJo in the message body. If you put other object, it may throw serialization exception or the object may become empty.</p>
</section>
<section id="asynchronous-drop-n-forget">
<h2>Asynchronous / Drop-n-forget<a class="headerlink" href="#asynchronous-drop-n-forget" title="Permalink to this headline"></a></h2>
<p>To make an asynchronous call, use the send method.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">send</span><span class="p">(</span><span class="n">String</span> <span class="n">to</span><span class="p">,</span> <span class="n">Kv</span><span class="p">...</span> <span class="n">parameters</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">send</span><span class="p">(</span><span class="n">String</span> <span class="n">to</span><span class="p">,</span> <span class="n">Object</span> <span class="n">body</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">send</span><span class="p">(</span><span class="n">String</span> <span class="n">to</span><span class="p">,</span> <span class="n">Object</span> <span class="n">body</span><span class="p">,</span> <span class="n">Kv</span><span class="p">...</span> <span class="n">parameters</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">send</span><span class="p">(</span><span class="kd">final</span> <span class="n">EventEnvelope</span> <span class="n">event</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="p">;</span>
</pre></div>
</div>
<p>Kv is a key-value pair for holding one parameter.</p>
</section>
<section id="deferred-delivery">
<h2>Deferred delivery<a class="headerlink" href="#deferred-delivery" title="Permalink to this headline"></a></h2>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">String</span> <span class="nf">sendLater</span><span class="p">(</span><span class="kd">final</span> <span class="n">EventEnvelope</span> <span class="n">event</span><span class="p">,</span> <span class="n">Date</span> <span class="n">future</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="p">;</span>
</pre></div>
</div>
<p>A scheduled ID will be returned. You may cancel the scheduled delivery with <code class="docutils literal notranslate"><span class="pre">cancelFutureEvent(id)</span></code>.</p>
</section>
<section id="call-back">
<h2>Call-back<a class="headerlink" href="#call-back" title="Permalink to this headline"></a></h2>
<p>You can register a call back function and uses its route name as the “reply-to” address in the send method. To set a reply-to address, you need to use the EventEnvelope directly.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">send</span><span class="p">(</span><span class="kd">final</span> <span class="n">EventEnvelope</span> <span class="n">event</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="p">;</span>

<span class="c1">// example</span>
<span class="n">EventEnvelope</span> <span class="n">event</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EventEnvelope</span><span class="p">();</span>
<span class="n">event</span><span class="p">.</span><span class="na">setTo</span><span class="p">(</span><span class="s">&quot;hello.world&quot;</span><span class="p">).</span><span class="na">setBody</span><span class="p">(</span><span class="n">somePayload</span><span class="p">);</span>
<span class="n">po</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
</pre></div>
</div>
<p>To handle exception from a target service, you may implement ServiceExceptionHandler. For example:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">SimpleCallback</span> <span class="kd">implements</span> <span class="n">TypedLambdaFunction</span><span class="o">&lt;</span><span class="n">PoJo</span><span class="p">,</span> <span class="n">Void</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">ServiceExceptionHandler</span> <span class="p">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onError</span><span class="p">(</span><span class="n">AppException</span> <span class="n">e</span><span class="p">,</span> <span class="n">EventEnvelope</span> <span class="n">event</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// handle exception here</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Void</span> <span class="nf">handleEvent</span><span class="p">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">headers</span><span class="p">,</span> <span class="n">PoJo</span> <span class="n">body</span><span class="p">,</span> <span class="kt">int</span> <span class="n">instance</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
        <span class="c1">// handle input. In this example, it is a PoJo</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="pipeline">
<h2>Pipeline<a class="headerlink" href="#pipeline" title="Permalink to this headline"></a></h2>
<p>In a pipeline operation, there is stepwise event propagation. e.g. Function A sends to B and set the “reply-to” as C. Function B sends to C and set the “reply-to” as D, etc.</p>
<p>To pass a list of stepwise targets, you may send the list as a parameter. Each function of the pipeline should forward the pipeline list to the next function.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">EventEnvelope</span> <span class="n">event</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EventEnvelope</span><span class="p">();</span>
<span class="n">event</span><span class="p">.</span><span class="na">setTo</span><span class="p">(</span><span class="s">&quot;function.b&quot;</span><span class="p">).</span><span class="na">setBody</span><span class="p">(</span><span class="n">somePayload</span><span class="p">).</span><span class="na">setReplyTo</span><span class="p">(</span><span class="s">&quot;function.c&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="na">setHeader</span><span class="p">(</span><span class="s">&quot;pipeline&quot;</span><span class="p">,</span>  <span class="s">&quot;function.a-&gt;function.b-&gt;function.c-&gt;function.d&quot;</span><span class="p">);</span>
<span class="n">po</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="streaming">
<h2>Streaming<a class="headerlink" href="#streaming" title="Permalink to this headline"></a></h2>
<p>You can use streams for functional programming. There are two ways to do streaming.</p>
<ol class="arabic simple">
<li><p>Singleton functions</p></li>
</ol>
<p>To create a singleton, you can set <code class="docutils literal notranslate"><span class="pre">instances</span></code> of the calling and called functions to 1. When you send events from the calling function to the called function, the platform guarantees that the event sequencing of the data stream.</p>
<p>To guarantee that there is only one instance of the calling and called function, you should register them with a globally unique route name. e.g. using UUID like “producer-b351e7df-827f-449c-904f-a80f9f3ecafe” and “consumer-d15b639a-44d9-4bc2-bb54-79db4f866fe3”.</p>
<p>Note that you can programmatically <code class="docutils literal notranslate"><span class="pre">register</span></code> and <code class="docutils literal notranslate"><span class="pre">release</span></code> a function at run-time.</p>
<p>If you create the functions at run-time, please remember to release the functions when processing is completed to avoid wasting system resources.</p>
<ol class="arabic simple" start="2">
<li><p>Object stream</p></li>
</ol>
<p>To do object streaming, you can use the ObjectStreamIO to create a stream or open an existing stream. Then, you can use the <code class="docutils literal notranslate"><span class="pre">ObjectStreamWriter</span></code> and the <code class="docutils literal notranslate"><span class="pre">ObjectStreamReader</span></code> classes to write to and read from the stream.</p>
<p>For the producer, if you close the output stream, the system will send a <code class="docutils literal notranslate"><span class="pre">EOF</span></code> to signal that there are no more events to the stream.</p>
<p>For the consumer, When you detect the end of stream, you can close the input stream to release the stream and all resources associated with it.</p>
<p>I/O stream consumes resources and thus you must close the input stream at the end of stream processing. The system will automatically close the stream upon an expiry timer that you provide when a new stream is created.</p>
<p>The following unit test demonstrates this use case.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">String</span> <span class="n">messageOne</span> <span class="o">=</span> <span class="s">&quot;hello world&quot;</span><span class="p">;</span>
<span class="n">String</span> <span class="n">messageTwo</span> <span class="o">=</span> <span class="s">&quot;it is great&quot;</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm">* Producer creates a new stream with 60 seconds inactivity expiry</span>
<span class="cm">*/</span>
<span class="n">ObjectStreamIO</span> <span class="n">stream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectStreamIO</span><span class="p">(</span><span class="mi">60</span><span class="p">);</span>
<span class="n">ObjectStreamWriter</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectStreamWriter</span><span class="p">(</span><span class="n">stream</span><span class="p">.</span><span class="na">getOutputStreamId</span><span class="p">());</span>
<span class="n">out</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">messageOne</span><span class="p">);</span>
<span class="n">out</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">messageTwo</span><span class="p">);</span>
<span class="cm">/*</span>
<span class="cm">* If output stream is closed, it will send an EOF signal so that the input stream reader will detect it.</span>
<span class="cm">* Otherwise, input stream reader will see a RuntimeException of timeout.</span>
<span class="cm">*</span>
<span class="cm">* For this test, we do not close the output stream to demonstrate the timeout.</span>
<span class="cm">*/</span>
<span class="c1">//  out.close();</span>

<span class="cm">/*</span>
<span class="cm">* Producer should send the inputStreamId to the consumer using &quot;stream.getInputStreamId()&quot; after the stream is created.</span>
<span class="cm">* The consumer can then open the stream with the streamId.</span>
<span class="cm">*/</span>
<span class="n">ObjectStreamReader</span> <span class="n">in</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectStreamReader</span><span class="p">(</span><span class="n">inputStreamId</span><span class="p">,</span> <span class="mi">8000</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">try</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">Object</span> <span class="n">data</span> <span class="p">:</span> <span class="n">in</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// EOF</span>
        <span class="n">i</span><span class="o">++</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">assertEquals</span><span class="p">(</span><span class="n">messageOne</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">assertEquals</span><span class="p">(</span><span class="n">messageTwo</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">RuntimeException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// iterator will timeout since the stream was not closed</span>
    <span class="n">assertTrue</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">().</span><span class="na">contains</span><span class="p">(</span><span class="s">&quot;timeout&quot;</span><span class="p">));</span>
<span class="p">}</span>

<span class="c1">// ensure that it has read the two messages</span>
<span class="n">assertEquals</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="c1">// must close input stream to release resources</span>
<span class="n">in</span><span class="p">.</span><span class="na">close</span><span class="p">();</span>
</pre></div>
</div>
</section>
<section id="broadcast">
<h2>Broadcast<a class="headerlink" href="#broadcast" title="Permalink to this headline"></a></h2>
<p>Broadcast is the easiest way to do “pub/sub”. To broadcast an event to multiple application instances, use the <code class="docutils literal notranslate"><span class="pre">broadcast</span></code> method.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">broadcast</span><span class="p">(</span><span class="n">String</span> <span class="n">to</span><span class="p">,</span> <span class="n">Kv</span><span class="p">...</span> <span class="n">parameters</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">broadcast</span><span class="p">(</span><span class="n">String</span> <span class="n">to</span><span class="p">,</span> <span class="n">Object</span> <span class="n">body</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">broadcast</span><span class="p">(</span><span class="n">String</span> <span class="n">to</span><span class="p">,</span> <span class="n">Object</span> <span class="n">body</span><span class="p">,</span> <span class="n">Kv</span><span class="p">...</span> <span class="n">parameters</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="p">;</span>

<span class="c1">// example</span>
<span class="n">po</span><span class="p">.</span><span class="na">broadcast</span><span class="p">(</span><span class="s">&quot;hello.world&quot;</span><span class="p">,</span> <span class="s">&quot;hey, this is a broadcast message to all hello.world providers&quot;</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="join-n-fork">
<h2>Join-n-fork<a class="headerlink" href="#join-n-fork" title="Permalink to this headline"></a></h2>
<p>You can perform join-n-fork RPC calls using a parallel version of the <code class="docutils literal notranslate"><span class="pre">request</span></code> method.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">List</span><span class="o">&lt;</span><span class="n">EventEnvelope</span><span class="o">&gt;</span> <span class="nf">request</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">EventEnvelope</span><span class="o">&gt;</span> <span class="n">events</span><span class="p">,</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="p">;</span>

<span class="c1">// example</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">EventEnvelope</span><span class="o">&gt;</span> <span class="n">parallelEvents</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>

<span class="n">EventEnvelope</span> <span class="n">event1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EventEnvelope</span><span class="p">();</span>
<span class="n">event1</span><span class="p">.</span><span class="na">setTo</span><span class="p">(</span><span class="s">&quot;hello.world.1&quot;</span><span class="p">);</span>
<span class="n">event1</span><span class="p">.</span><span class="na">setBody</span><span class="p">(</span><span class="n">payload1</span><span class="p">);</span>
<span class="n">event1</span><span class="p">.</span><span class="na">setHeader</span><span class="p">(</span><span class="s">&quot;request&quot;</span><span class="p">,</span> <span class="s">&quot;#1&quot;</span><span class="p">);</span>
<span class="n">parallelEvents</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">event1</span><span class="p">);</span>

<span class="n">EventEnvelope</span> <span class="n">event2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EventEnvelope</span><span class="p">();</span>
<span class="n">event2</span><span class="p">.</span><span class="na">setTo</span><span class="p">(</span><span class="s">&quot;hello.world.2&quot;</span><span class="p">);</span>
<span class="n">event2</span><span class="p">.</span><span class="na">setBody</span><span class="p">(</span><span class="n">payload2</span><span class="p">);</span>
<span class="n">event2</span><span class="p">.</span><span class="na">setHeader</span><span class="p">(</span><span class="s">&quot;request&quot;</span><span class="p">,</span> <span class="s">&quot;#2&quot;</span><span class="p">);</span>
<span class="n">parallelEvents</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">event2</span><span class="p">);</span>

<span class="n">List</span><span class="o">&lt;</span><span class="n">EventEnvelope</span><span class="o">&gt;</span> <span class="n">responses</span> <span class="o">=</span> <span class="n">po</span><span class="p">.</span><span class="na">request</span><span class="p">(</span><span class="n">parallelEvents</span><span class="p">,</span> <span class="mi">3000</span><span class="p">);</span>
</pre></div>
</div>
<p>A non-blocking version of fork-n-join is available with the <code class="docutils literal notranslate"><span class="pre">asyncRequest</span></code> method. Only timeout exception will be sent to the onFailure method. All other cases will be delivered to the onSuccess method. You should check event.getStatus() to handle exception.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">Future</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">EventEnvelope</span><span class="o">&gt;&gt;</span> <span class="nf">asyncRequest</span><span class="p">(</span><span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">EventEnvelope</span><span class="o">&gt;</span> <span class="n">event</span><span class="p">,</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="p">;</span>

<span class="c1">// example</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">EventEnvelope</span><span class="o">&gt;</span> <span class="n">requests</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="n">requests</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span> <span class="n">EventEnvelope</span><span class="p">().</span><span class="na">setTo</span><span class="p">(</span><span class="n">SERVICE1</span><span class="p">).</span><span class="na">setBody</span><span class="p">(</span><span class="n">TEXT1</span><span class="p">));</span>
<span class="n">requests</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span> <span class="n">EventEnvelope</span><span class="p">().</span><span class="na">setTo</span><span class="p">(</span><span class="n">SERVICE2</span><span class="p">).</span><span class="na">setBody</span><span class="p">(</span><span class="n">TEXT2</span><span class="p">));</span>
<span class="n">Future</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">EventEnvelope</span><span class="o">&gt;&gt;</span> <span class="n">future</span> <span class="o">=</span> <span class="n">po</span><span class="p">.</span><span class="na">asyncRequest</span><span class="p">(</span><span class="n">requests</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span>
<span class="n">future</span><span class="p">.</span><span class="na">onSuccess</span><span class="p">(</span><span class="n">events</span> <span class="o">-&gt;</span> <span class="p">{</span>
    <span class="c1">// handle the response events</span>
<span class="p">}).</span><span class="na">onFailure</span><span class="p">(</span><span class="n">ex</span> <span class="o">-&gt;</span> <span class="p">{</span>
    <span class="c1">// handle timeout exception</span>
<span class="p">});</span>
</pre></div>
</div>
</section>
<section id="inspecting-event-s-metadata">
<h2>Inspecting event’s metadata<a class="headerlink" href="#inspecting-event-s-metadata" title="Permalink to this headline"></a></h2>
<p>If you want to inspect the incoming event’s metadata to make some decisions such as checking correlation-ID and sender’s route address, you can use the TypedLambdaFunction to specify input as EventEnvelope.</p>
<p>Another way to inspect event’s metadata is the use of the EventInterceptor annotation in your lambda function. Note that event interceptor service does not return result, it intercepts incoming event for forwarding to one or more target services. If the incoming request is a RPC call and the interceptor does not forward the event to the target service, the call will time out.</p>
</section>
<section id="default-pojo-mapping">
<h2>Default PoJo mapping<a class="headerlink" href="#default-pojo-mapping" title="Permalink to this headline"></a></h2>
<p>PoJo mapping is determined at the source. When the caller function sets the PoJo, the object is restored as the original PoJo in the target service provided that the common data model is available in both source and target services.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">Object</span> <span class="nf">getBody</span><span class="p">();</span> <span class="c1">// &lt;-- default mapping</span>
</pre></div>
</div>
</section>
<section id="retrieve-raw-data-as-a-map">
<h2>Retrieve raw data as a Map<a class="headerlink" href="#retrieve-raw-data-as-a-map" title="Permalink to this headline"></a></h2>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">Object</span> <span class="nf">getRawBody</span><span class="p">();</span>
</pre></div>
</div>
</section>
<section id="custom-pojo-mapping">
<h2>Custom PoJo mapping<a class="headerlink" href="#custom-pojo-mapping" title="Permalink to this headline"></a></h2>
<p>In case you want to do custom mapping, the platform will carry out best effort mapping from the source PoJo to the target PoJo. You must ensure the target object is compatible with the source PoJo. Otherwise, there will be data lost or casting error.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="nf">getBody</span><span class="p">(</span><span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">toValueType</span><span class="p">);</span> <span class="c1">// &lt;-- custom mapping</span>
<span class="kd">public</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="nf">getBody</span><span class="p">(</span><span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">toValueType</span><span class="p">,</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="p">...</span> <span class="n">parameterClass</span><span class="p">);</span> <span class="c1">// custom generics</span>
</pre></div>
</div>
</section>
<section id="check-if-a-target-service-is-available">
<h2>Check if a target service is available<a class="headerlink" href="#check-if-a-target-service-is-available" title="Permalink to this headline"></a></h2>
<p>To check if a target service is available, you can use the <code class="docutils literal notranslate"><span class="pre">exists</span></code> method.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kt">boolean</span> <span class="n">po</span><span class="p">.</span><span class="na">exists</span><span class="p">(</span><span class="n">String</span><span class="p">...</span> <span class="n">route</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="n">po</span><span class="p">.</span><span class="na">exists</span><span class="p">(</span><span class="s">&quot;hello.world&quot;</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// do something</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="n">po</span><span class="p">.</span><span class="na">exists</span><span class="p">(</span><span class="s">&quot;hello.math&quot;</span><span class="p">,</span> <span class="s">&quot;v1.diff.equation&quot;</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// do other things</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This service discovery process is instantaneous using distributed routing table.</p>
</section>
<section id="get-a-list-of-application-instances-that-provide-a-certain-service">
<h2>Get a list of application instances that provide a certain service<a class="headerlink" href="#get-a-list-of-application-instances-that-provide-a-certain-service" title="Permalink to this headline"></a></h2>
<p>The search method is usually used for leader election for a certain service if more than one app instance is available.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">originIDs</span> <span class="o">=</span> <span class="n">po</span><span class="p">.</span><span class="na">search</span><span class="p">(</span><span class="n">String</span> <span class="n">route</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="pub-sub-for-store-n-forward-event-streaming">
<h2>Pub/Sub for store-n-forward event streaming<a class="headerlink" href="#pub-sub-for-store-n-forward-event-streaming" title="Permalink to this headline"></a></h2>
<p>Mercury provides real-time inter-service event streaming and you do not need to deal with low-level messaging.</p>
<p>However, if you want to do store-n-forward pub/sub for certain use cases, you may use the PubSub class.</p>
<p>In event streaming, pub/sub refers to the long term storage of events for event playback or “time rewind”. For example, this “commit log” architecture is available in Apache Kafka.</p>
<p>To test if the underlying event system supports pub/sub, use the “isStreamingPubSub” API.</p>
<p>Following are some useful pub/sub API:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">featureEnabled</span><span class="p">();</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">createTopic</span><span class="p">(</span><span class="n">String</span> <span class="n">topic</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="p">;</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">createTopic</span><span class="p">(</span><span class="n">String</span> <span class="n">topic</span><span class="p">,</span> <span class="kt">int</span> <span class="n">partitions</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="p">;</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">deleteTopic</span><span class="p">(</span><span class="n">String</span> <span class="n">topic</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="p">;</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">publish</span><span class="p">(</span><span class="n">String</span> <span class="n">topic</span><span class="p">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">headers</span><span class="p">,</span> <span class="n">Object</span> <span class="n">body</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="p">;</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">publish</span><span class="p">(</span><span class="n">String</span> <span class="n">topic</span><span class="p">,</span> <span class="kt">int</span> <span class="n">partition</span><span class="p">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">headers</span><span class="p">,</span> <span class="n">Object</span> <span class="n">body</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="p">;</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">subscribe</span><span class="p">(</span><span class="n">String</span> <span class="n">topic</span><span class="p">,</span> <span class="n">LambdaFunction</span> <span class="n">listener</span><span class="p">,</span> <span class="n">String</span><span class="p">...</span> <span class="n">parameters</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="p">;</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">subscribe</span><span class="p">(</span><span class="n">String</span> <span class="n">topic</span><span class="p">,</span> <span class="kt">int</span> <span class="n">partition</span><span class="p">,</span> <span class="n">LambdaFunction</span> <span class="n">listener</span><span class="p">,</span> <span class="n">String</span><span class="p">...</span> <span class="n">parameters</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="p">;</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">unsubscribe</span><span class="p">(</span><span class="n">String</span> <span class="n">topic</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="p">;</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">unsubscribe</span><span class="p">(</span><span class="n">String</span> <span class="n">topic</span><span class="p">,</span> <span class="kt">int</span> <span class="n">partition</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="p">;</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">exists</span><span class="p">(</span><span class="n">String</span> <span class="n">topic</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="p">;</span>
<span class="kd">public</span> <span class="kt">int</span> <span class="nf">partitionCount</span><span class="p">(</span><span class="n">String</span> <span class="n">topic</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="p">;</span>
<span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">list</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="p">;</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isStreamingPubSub</span><span class="p">();</span>
</pre></div>
</div>
<p>Some pub/sub engine would require additional parameters when subscribing a topic. For Kafka, you must provide the following parameters</p>
<ol class="arabic simple">
<li><p>clientId</p></li>
<li><p>groupId</p></li>
<li><p>optional read offset pointer</p></li>
</ol>
<p>If the offset pointer is not given, Kafka will position the read pointer to the latest when the clientId and groupId are first seen. Thereafter, Kafka will remember the read pointer for the groupId and resume read from the last read pointer.</p>
<p>As a result, for proper subscription, you must create the topic first and then create a lambda function to subscribe to the topic before publishing anything to the topic.</p>
<p>To read the event stream of a topic from the beginning, you can set offset to “0”.</p>
<p>The system encapsulates the headers and body (aka payload) in an event envelope so that you do not need to do serialization yourself. The payload can be PoJo, Map or Java primitives.</p>
</section>
<section id="thread-safety">
<h2>Thread safety<a class="headerlink" href="#thread-safety" title="Permalink to this headline"></a></h2>
<p>The “handleEvent” is the event handler for each LamdbaFunction. When you register more than one worker instance for your function, please ensure that you use “functional scope” variables instead of global scope variables.</p>
<p>If you must use global scope variables, please use Java Concurrent collections.</p>
</section>
<section id="exception-handling">
<h2>Exception handling<a class="headerlink" href="#exception-handling" title="Permalink to this headline"></a></h2>
<p>When your lambda function throws exception, the exception will be encapsulated in the result event envelope to the calling function.</p>
<p>If your calling function uses RPC, the exception will be caught as an AppException. You can then use the exception’s getCause() method to retrieve the original exception chain from the called function.</p>
<p>If your calling function uses CALLBACK pattern, your callback function can inspect the incoming event envelope and use the getException() method to obtain the original exception chain from the called function.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="platform-api.html" class="btn btn-neutral float-left" title="Platform API" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="rest-automation.html" class="btn btn-neutral float-right" title="Rest Automation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>